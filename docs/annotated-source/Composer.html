<!DOCTYPE html>

<html>
<head>
  <title>Composer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="OSG.html">
                OSG.js
              </a>
            
              
              <a class="source" href="BlendColor.html">
                BlendColor.js
              </a>
            
              
              <a class="source" href="BlendFunc.html">
                BlendFunc.js
              </a>
            
              
              <a class="source" href="BoundingBox.html">
                BoundingBox.js
              </a>
            
              
              <a class="source" href="BoundingSphere.html">
                BoundingSphere.js
              </a>
            
              
              <a class="source" href="BufferArray.html">
                BufferArray.js
              </a>
            
              
              <a class="source" href="Camera.html">
                Camera.js
              </a>
            
              
              <a class="source" href="ComputeMatrixFromNodePath.html">
                ComputeMatrixFromNodePath.js
              </a>
            
              
              <a class="source" href="CullFace.html">
                CullFace.js
              </a>
            
              
              <a class="source" href="CullSettings.html">
                CullSettings.js
              </a>
            
              
              <a class="source" href="CullStack.html">
                CullStack.js
              </a>
            
              
              <a class="source" href="CullVisitor.html">
                CullVisitor.js
              </a>
            
              
              <a class="source" href="Depth.html">
                Depth.js
              </a>
            
              
              <a class="source" href="DrawArrayLengths.html">
                DrawArrayLengths.js
              </a>
            
              
              <a class="source" href="DrawArrays.html">
                DrawArrays.js
              </a>
            
              
              <a class="source" href="DrawElements.html">
                DrawElements.js
              </a>
            
              
              <a class="source" href="EllipsoidModel.html">
                EllipsoidModel.js
              </a>
            
              
              <a class="source" href="FrameBufferObject.html">
                FrameBufferObject.js
              </a>
            
              
              <a class="source" href="FrameStamp.html">
                FrameStamp.js
              </a>
            
              
              <a class="source" href="Geometry.html">
                Geometry.js
              </a>
            
              
              <a class="source" href="Image.html">
                Image.js
              </a>
            
              
              <a class="source" href="KdTree.html">
                KdTree.js
              </a>
            
              
              <a class="source" href="KdTreeBuilder.html">
                KdTreeBuilder.js
              </a>
            
              
              <a class="source" href="Light.html">
                Light.js
              </a>
            
              
              <a class="source" href="LightSource.html">
                LightSource.js
              </a>
            
              
              <a class="source" href="LineWidth.html">
                LineWidth.js
              </a>
            
              
              <a class="source" href="Material.html">
                Material.js
              </a>
            
              
              <a class="source" href="Math.html">
                Math.js
              </a>
            
              
              <a class="source" href="Matrix.html">
                Matrix.js
              </a>
            
              
              <a class="source" href="MatrixTransform.html">
                MatrixTransform.js
              </a>
            
              
              <a class="source" href="Node.html">
                Node.js
              </a>
            
              
              <a class="source" href="NodeVisitor.html">
                NodeVisitor.js
              </a>
            
              
              <a class="source" href="Notify.html">
                Notify.js
              </a>
            
              
              <a class="source" href="Object.html">
                Object.js
              </a>
            
              
              <a class="source" href="PrimitiveSet.html">
                PrimitiveSet.js
              </a>
            
              
              <a class="source" href="Program.html">
                Program.js
              </a>
            
              
              <a class="source" href="Projection.html">
                Projection.js
              </a>
            
              
              <a class="source" href="Quat.html">
                Quat.js
              </a>
            
              
              <a class="source" href="RenderBin.html">
                RenderBin.js
              </a>
            
              
              <a class="source" href="RenderStage.html">
                RenderStage.js
              </a>
            
              
              <a class="source" href="Shader.html">
                Shader.js
              </a>
            
              
              <a class="source" href="ShaderGenerator.html">
                ShaderGenerator.js
              </a>
            
              
              <a class="source" href="Shape.html">
                Shape.js
              </a>
            
              
              <a class="source" href="Stack.html">
                Stack.js
              </a>
            
              
              <a class="source" href="State.html">
                State.js
              </a>
            
              
              <a class="source" href="StateAttribute.html">
                StateAttribute.js
              </a>
            
              
              <a class="source" href="StateGraph.html">
                StateGraph.js
              </a>
            
              
              <a class="source" href="StateSet.html">
                StateSet.js
              </a>
            
              
              <a class="source" href="Texture.html">
                Texture.js
              </a>
            
              
              <a class="source" href="TextureCubeMap.html">
                TextureCubeMap.js
              </a>
            
              
              <a class="source" href="Transform.html">
                Transform.js
              </a>
            
              
              <a class="source" href="TransformEnums.html">
                TransformEnums.js
              </a>
            
              
              <a class="source" href="TriangleIndexFunctor.html">
                TriangleIndexFunctor.js
              </a>
            
              
              <a class="source" href="Uniform.html">
                Uniform.js
              </a>
            
              
              <a class="source" href="UpdateVisitor.html">
                UpdateVisitor.js
              </a>
            
              
              <a class="source" href="Utils.html">
                Utils.js
              </a>
            
              
              <a class="source" href="Vec2.html">
                Vec2.js
              </a>
            
              
              <a class="source" href="Vec3.html">
                Vec3.js
              </a>
            
              
              <a class="source" href="Vec4.html">
                Vec4.js
              </a>
            
              
              <a class="source" href="Viewport.html">
                Viewport.js
              </a>
            
              
              <a class="source" href="osg.html">
                osg.js
              </a>
            
              
              <a class="source" href="Animation.html">
                Animation.js
              </a>
            
              
              <a class="source" href="AnimationUpdateCallback.html">
                AnimationUpdateCallback.js
              </a>
            
              
              <a class="source" href="BasicAnimationManager.html">
                BasicAnimationManager.js
              </a>
            
              
              <a class="source" href="Channel.html">
                Channel.js
              </a>
            
              
              <a class="source" href="Easing.html">
                Easing.js
              </a>
            
              
              <a class="source" href="FloatLerpChannel.html">
                FloatLerpChannel.js
              </a>
            
              
              <a class="source" href="FloatTarget.html">
                FloatTarget.js
              </a>
            
              
              <a class="source" href="Interpolator.html">
                Interpolator.js
              </a>
            
              
              <a class="source" href="Keyframe.html">
                Keyframe.js
              </a>
            
              
              <a class="source" href="LinkVisitor.html">
                LinkVisitor.js
              </a>
            
              
              <a class="source" href="QuatLerpChannel.html">
                QuatLerpChannel.js
              </a>
            
              
              <a class="source" href="QuatSlerpChannel.html">
                QuatSlerpChannel.js
              </a>
            
              
              <a class="source" href="QuatTarget.html">
                QuatTarget.js
              </a>
            
              
              <a class="source" href="Sampler.html">
                Sampler.js
              </a>
            
              
              <a class="source" href="StackedQuaternion.html">
                StackedQuaternion.js
              </a>
            
              
              <a class="source" href="StackedRotateAxis.html">
                StackedRotateAxis.js
              </a>
            
              
              <a class="source" href="StackedTranslate.html">
                StackedTranslate.js
              </a>
            
              
              <a class="source" href="Target.html">
                Target.js
              </a>
            
              
              <a class="source" href="UpdateMatrixTransform.html">
                UpdateMatrixTransform.js
              </a>
            
              
              <a class="source" href="Vec3LerpChannel.html">
                Vec3LerpChannel.js
              </a>
            
              
              <a class="source" href="Vec3Target.html">
                Vec3Target.js
              </a>
            
              
              <a class="source" href="osgAnimation.html">
                osgAnimation.js
              </a>
            
              
              <a class="source" href="Input.html">
                Input.js
              </a>
            
              
              <a class="source" href="Options.html">
                Options.js
              </a>
            
              
              <a class="source" href="ReaderParser.html">
                ReaderParser.js
              </a>
            
              
              <a class="source" href="osgDB.html">
                osgDB.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulator.html">
                FirstPersonManipulator.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorMouseKeyboardController.html">
                FirstPersonManipulatorMouseKeyboardController.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorOculusController.html">
                FirstPersonManipulatorOculusController.js
              </a>
            
              
              <a class="source" href="Manipulator.html">
                Manipulator.js
              </a>
            
              
              <a class="source" href="OrbitManipulator.html">
                OrbitManipulator.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorEnums.html">
                OrbitManipulatorEnums.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorGamePadController.html">
                OrbitManipulatorGamePadController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorHammerController.html">
                OrbitManipulatorHammerController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorLeapMotionController.html">
                OrbitManipulatorLeapMotionController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorMouseKeyboardController.html">
                OrbitManipulatorMouseKeyboardController.js
              </a>
            
              
              <a class="source" href="SwitchManipulator.html">
                SwitchManipulator.js
              </a>
            
              
              <a class="source" href="osgGA.html">
                osgGA.js
              </a>
            
              
              <a class="source" href="osgNameSpace.html">
                osgNameSpace.js
              </a>
            
              
              <a class="source" href="Composer.html">
                Composer.js
              </a>
            
              
              <a class="source" href="IntersectVisitor.html">
                IntersectVisitor.js
              </a>
            
              
              <a class="source" href="ParameterVisitor.html">
                ParameterVisitor.js
              </a>
            
              
              <a class="source" href="TriangleIntersect.html">
                TriangleIntersect.js
              </a>
            
              
              <a class="source" href="osgPool.html">
                osgPool.js
              </a>
            
              
              <a class="source" href="osgUtil.html">
                osgUtil.js
              </a>
            
              
              <a class="source" href="View.html">
                View.js
              </a>
            
              
              <a class="source" href="Viewer.html">
                Viewer.js
              </a>
            
              
              <a class="source" href="EventProxy.html">
                EventProxy.js
              </a>
            
              
              <a class="source" href="GamePad.html">
                GamePad.js
              </a>
            
              
              <a class="source" href="Hammer.html">
                Hammer.js
              </a>
            
              
              <a class="source" href="LeapMotion.html">
                LeapMotion.js
              </a>
            
              
              <a class="source" href="Oculus.html">
                Oculus.js
              </a>
            
              
              <a class="source" href="StandardMouseKeyboard.html">
                StandardMouseKeyboard.js
              </a>
            
              
              <a class="source" href="osgViewer.html">
                osgViewer.js
              </a>
            
              
              <a class="source" href="stats.html">
                stats.js
              </a>
            
              
              <a class="source" href="webgl-debug.html">
                webgl-debug.js
              </a>
            
              
              <a class="source" href="webgl-utils.html">
                webgl-utils.js
              </a>
            
              
              <a class="source" href="osg.html">
                osg.js
              </a>
            
              
              <a class="source" href="osgAnimation.html">
                osgAnimation.js
              </a>
            
              
              <a class="source" href="Hammer.html">
                Hammer.js
              </a>
            
              
              <a class="source" href="Leap.html">
                Leap.js
              </a>
            
              
              <a class="source" href="Q.html">
                Q.js
              </a>
            
              
              <a class="source" href="vr.html">
                vr.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Composer.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>define( [
    <span class="hljs-string">'osg/Notify'</span>,
    <span class="hljs-string">'osg/Utils'</span>,
    <span class="hljs-string">'osg/Node'</span>,
    <span class="hljs-string">'osg/Depth'</span>,
    <span class="hljs-string">'osg/Texture'</span>,
    <span class="hljs-string">'osg/Camera'</span>,
    <span class="hljs-string">'osg/FrameBufferObject'</span>,
    <span class="hljs-string">'osg/Viewport'</span>,
    <span class="hljs-string">'osg/Matrix'</span>,
    <span class="hljs-string">'osg/Uniform'</span>,
    <span class="hljs-string">'osg/StateSet'</span>,
    <span class="hljs-string">'osg/Program'</span>,
    <span class="hljs-string">'osg/Shader'</span>,
    <span class="hljs-string">'osg/Shape'</span>,
    <span class="hljs-string">'osg/TransformEnums'</span>,
    <span class="hljs-string">'osg/Vec3'</span>
], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( Notify, MACROUTILS, Node, Depth, Texture, Camera, FrameBufferObject, Viewport, Matrix,  Uniform, StateSet, Program, Shader, Shape, TransformEnums, Vec3 )</span> {</span>

    <span class="hljs-comment">/*
     Composer is an helper to create post fx. The idea is to push one or more textures into a pipe of shader filter.

     how to use it:

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>example how to blur a texture and render it to screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>     <span class="hljs-keyword">var</span> myTexture; <span class="hljs-comment">// imagine it's your texture you want to process</span>
     <span class="hljs-keyword">var</span> composer = <span class="hljs-keyword">new</span> Composer();
     composer.addPass(<span class="hljs-keyword">new</span> Composer.Filter.InputTexture(myTexture));
     composer.addPass(<span class="hljs-keyword">new</span> Composer.Filter.HBlur(<span class="hljs-number">5</span>));
     composer.addPass(<span class="hljs-keyword">new</span> Composer.Filter.VBlur(<span class="hljs-number">5</span>));
     composer.renderToScreen(<span class="hljs-number">1200</span>, <span class="hljs-number">900</span>);
     composer.build(); <span class="hljs-comment">// if you dont build manually it will be done in the scenegraph while upading</span>
     rootnode.addChild(composer);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>now you can imagine to some process and use the result as input texture for a geometry</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>     var myTexture; // imagine it's your texture you want to process
     var myResultTexture = new Texture(); // imagine it's your texture you want to process
     myResultTexture.setTextureSize(1200,900);
     var composer = new Composer();
     composer.addPass(new Composer.Filter.InputTexture(myTexture));
     composer.addPass(new Composer.Filter.HBlur(5));
     composer.addPass(new Composer.Filter.VBlur(5), resultTexture);

     myGeometry.getStateSet().setTextureAttributeAndModes(0, resultTexture);
     rootnode.addChild(composer);

     */

    var Composer = function () {
        Node.call( this );
        this._stack = [];
        this._renderToScreen = false;
        this._dirty = false;
        var UpdateCallback = function () {

        };
        UpdateCallback.prototype = {
            update: function ( node /*, nv */ ) {
                if ( node.isDirty() ) {
                    node.build();
                }
            }
        };
        this.setUpdateCallback( new UpdateCallback() );
        this.getOrCreateStateSet().setAttributeAndModes( new Depth( 'DISABLE' ) );
    };

    Composer.prototype = MACROUTILS.objectInehrit( Node.prototype, {
        dirty: function () {
            for ( var i = 0, l = this._stack.length; i &lt; l; i++ ) {
                this._stack[ i ].filter.dirty();
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>addPass support different signature
addPass(filter) -&gt; the filter will be done on a texture of the same size than the previous pass
addPass(filter, textureWidth, textureHeight) -&gt; the filter will be done on a texture width and height
addPass(filter, texture) -&gt; the filter will be done on the giver texture using its width and height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        addPass: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( filter, arg0, arg1 )</span> {</span>
            <span class="hljs-keyword">if</span> ( arg0 <span class="hljs-keyword">instanceof</span> Texture ) {
                <span class="hljs-keyword">this</span>._stack.push( {
                    filter: filter,
                    texture: arg0
                } );
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( arg0 !== <span class="hljs-literal">undefined</span> &amp;&amp; arg1 !== <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">this</span>._stack.push( {
                    filter: filter,
                    width: <span class="hljs-built_in">Math</span>.floor( arg0 ),
                    height: <span class="hljs-built_in">Math</span>.floor( arg1 )
                } );
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>._stack.push( {
                    filter: filter
                } );
            }
        },
        renderToScreen: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( w, h )</span> {</span>
            <span class="hljs-keyword">this</span>._renderToScreen = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">this</span>._renderToScreenWidth = w;
            <span class="hljs-keyword">this</span>._renderToScreenHeight = h;
        },

        isDirty: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = <span class="hljs-keyword">this</span>._stack.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._stack[ i ].filter.isDirty() ) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        },

        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">this</span>.removeChildren();
            <span class="hljs-keyword">var</span> lastTextureResult;
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">this</span>._stack.forEach( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( element, i, array )</span> {</span>
                <span class="hljs-keyword">if</span> ( element.filter.isDirty() ) {
                    element.filter.build();
                }
                <span class="hljs-keyword">var</span> stateSet = element.filter.getStateSet();
                <span class="hljs-keyword">var</span> w, h;
                <span class="hljs-keyword">if</span> ( element.texture !== <span class="hljs-literal">undefined</span> ) {
                    w = element.texture.getWidth();
                    h = element.texture.getHeight();
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( element.width !== <span class="hljs-literal">undefined</span> &amp;&amp; element.height !== <span class="hljs-literal">undefined</span> ) {
                    w = element.width;
                    h = element.height;
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>get width from Texture0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> inputTexture = stateSet.getTextureAttribute( <span class="hljs-number">0</span>, <span class="hljs-string">'Texture'</span> );
                    <span class="hljs-keyword">if</span> ( inputTexture === <span class="hljs-literal">undefined</span> ) {
                        Notify.warn( <span class="hljs-string">'Composer can\'t find any information to setup texture output size'</span> );
                    }
                    w = inputTexture.getWidth();
                    h = inputTexture.getHeight();
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>is it the last filter and we want to render to screen ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> lastFilterRenderToScreen = ( i === array.length - <span class="hljs-number">1</span> &amp;&amp;
                    self._renderToScreen === <span class="hljs-literal">true</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>check if we have something to do
else we will just translate stateset to the next filter
this part exist to manage the Composer.Filter.InputTexture that setup the first texture unit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> ( !lastFilterRenderToScreen ) {
                    <span class="hljs-keyword">if</span> ( stateSet.getAttribute( <span class="hljs-string">'Program'</span> ) === <span class="hljs-literal">undefined</span> ) {
                        array[ i + <span class="hljs-number">1</span> ].filter.getStateSet().setTextureAttributeAndModes( <span class="hljs-number">0</span>, stateSet.getTextureAttribute( <span class="hljs-number">0</span>, <span class="hljs-string">'Texture'</span> ) );
                        <span class="hljs-keyword">return</span>;
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>check if we want to render on screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> camera = <span class="hljs-keyword">new</span> Camera();
                camera.setClearMask( <span class="hljs-number">0</span> );

                <span class="hljs-keyword">var</span> texture;
                <span class="hljs-keyword">var</span> quad;
                <span class="hljs-keyword">if</span> ( lastFilterRenderToScreen === <span class="hljs-literal">true</span> ) {
                    w = self._renderToScreenWidth;
                    h = self._renderToScreenHeight;
                } <span class="hljs-keyword">else</span> {
                    camera.setRenderOrder( Camera.PRE_RENDER, <span class="hljs-number">0</span> );
                    texture = element.texture;
                    <span class="hljs-keyword">if</span> ( texture === <span class="hljs-literal">undefined</span> ) {
                        texture = <span class="hljs-keyword">new</span> Texture();
                        texture.setTextureSize( w, h );
                    }
                    camera.attachTexture( FrameBufferObject.COLOR_ATTACHMENT0, texture, <span class="hljs-number">0</span> );
                }

                <span class="hljs-keyword">var</span> vp = <span class="hljs-keyword">new</span> Viewport( <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h );
                <span class="hljs-keyword">var</span> projection = Matrix.makeOrtho( -w / <span class="hljs-number">2</span>, w / <span class="hljs-number">2</span>, -h / <span class="hljs-number">2</span>, h / <span class="hljs-number">2</span>, -<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, [] );
                camera.setReferenceFrame( TransformEnums.ABSOLUTE_RF );
                camera.setViewport( vp );
                camera.setProjectionMatrix( projection );
                camera.setStateSet( element.filter.getStateSet() );

                quad = Shape.createTexturedQuadGeometry( -w / <span class="hljs-number">2</span>, -h / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>,
                    w, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,
                    <span class="hljs-number">0</span>, h, <span class="hljs-number">0</span> );

                <span class="hljs-keyword">if</span> ( element.filter.buildGeometry !== <span class="hljs-literal">undefined</span> )
                    quad = element.filter.buildGeometry( quad );

                quad.setName( <span class="hljs-string">'composer layer'</span> );

                lastTextureResult = texture;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>assign the result texture to the next stateset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> ( i + <span class="hljs-number">1</span> &lt; array.length ) {
                    array[ i + <span class="hljs-number">1</span> ].filter.getStateSet().setTextureAttributeAndModes( <span class="hljs-number">0</span>, lastTextureResult );
                }

                camera.addChild( quad );
                element.filter.getStateSet().addUniform( Uniform.createFloat2( [ w, h ], <span class="hljs-string">'RenderSize'</span> ) );
                camera.setName( <span class="hljs-string">'Composer Pass'</span> + i );
                root.addChild( camera );
            } );
            <span class="hljs-keyword">this</span>._resultTexture = lastTextureResult;
        }
    } );

    Composer.Filter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">this</span>._stateSet = <span class="hljs-keyword">new</span> StateSet();
        <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">true</span>;
    };

    Composer.Filter.prototype = {
        getStateSet: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._stateSet;
        },
        getOrCreateStateSet: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._stateSet;
        },
        dirty: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">true</span>;
        },
        isDirty: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._dirty;
        }
    };


    Composer.Filter.defaultVertexShader = [
        <span class="hljs-string">'#ifdef GL_ES'</span>,
        <span class="hljs-string">'precision highp float;'</span>,
        <span class="hljs-string">'#endif'</span>,
        <span class="hljs-string">'attribute vec3 Vertex;'</span>,
        <span class="hljs-string">'attribute vec2 TexCoord0;'</span>,
        <span class="hljs-string">'varying vec2 FragTexCoord0;'</span>,
        <span class="hljs-string">'uniform mat4 ModelViewMatrix;'</span>,
        <span class="hljs-string">'uniform mat4 ProjectionMatrix;'</span>,
        <span class="hljs-string">'void main(void) {'</span>,
        <span class="hljs-string">'  gl_Position = ProjectionMatrix * ModelViewMatrix * vec4(Vertex,1.0);'</span>,
        <span class="hljs-string">'  FragTexCoord0 = TexCoord0;'</span>,
        <span class="hljs-string">'}'</span>,
        <span class="hljs-string">''</span>
    ].join( <span class="hljs-string">'\n'</span> );

    Composer.Filter.defaultFragmentShaderHeader = [
        <span class="hljs-string">'#ifdef GL_ES'</span>,
        <span class="hljs-string">'precision highp float;'</span>,
        <span class="hljs-string">'#endif'</span>,
        <span class="hljs-string">'varying vec2 FragTexCoord0;'</span>,
        <span class="hljs-string">'uniform vec2 RenderSize;'</span>,
        <span class="hljs-string">'uniform sampler2D Texture0;'</span>,
        <span class="hljs-string">''</span>
    ].join( <span class="hljs-string">'\n'</span> );

    Composer.Filter.shaderUtils = [
        <span class="hljs-string">'vec4 packFloatTo4x8(in float v) {'</span>,
        <span class="hljs-string">'vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;'</span>,
        <span class="hljs-string">'enc = fract(enc);'</span>,
        <span class="hljs-string">'enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);'</span>,
        <span class="hljs-string">'return enc;'</span>,
        <span class="hljs-string">'}'</span>,

        <span class="hljs-string">' '</span>,
        <span class="hljs-string">'vec4 pack2FloatTo4x8(in vec2 val) {'</span>,
        <span class="hljs-string">' const vec2 bitSh = vec2(256.0, 1.0);'</span>,
        <span class="hljs-string">' const vec2 bitMsk = vec2(0.0, 1.0/256.0);'</span>,
        <span class="hljs-string">' vec2 res1 = fract(val.x * bitSh);'</span>,
        <span class="hljs-string">' res1 -= res1.xx * bitMsk;'</span>,
        <span class="hljs-string">' vec2 res2 = fract(val.y * bitSh);'</span>,
        <span class="hljs-string">' res2 -= res2.xx * bitMsk;'</span>,
        <span class="hljs-string">' return vec4(res1.x,res1.y,res2.x,res2.y);'</span>,
        <span class="hljs-string">'}'</span>,
        <span class="hljs-string">' '</span>,
        <span class="hljs-string">'float unpack4x8ToFloat( vec4 rgba ) {'</span>,
        <span class="hljs-string">' return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );'</span>,
        <span class="hljs-string">'}'</span>,
        <span class="hljs-string">' '</span>,
        <span class="hljs-string">'vec2 unpack4x8To2Float(in vec4 val) {'</span>,
        <span class="hljs-string">' const vec2 unshift = vec2(1.0/256.0, 1.0);'</span>,
        <span class="hljs-string">' return vec2(dot(val.xy, unshift), dot(val.zw, unshift));'</span>,
        <span class="hljs-string">'}'</span>,

        <span class="hljs-string">'vec2 encodeNormal (vec3 n)'</span>,
        <span class="hljs-string">'{'</span>,
        <span class="hljs-string">'    float f = sqrt(8.0*n.z+8.0);'</span>,
        <span class="hljs-string">'    return n.xy / f + 0.5;'</span>,
        <span class="hljs-string">'}'</span>,

        <span class="hljs-string">'vec3 decodeNormal (vec2 enc)'</span>,
        <span class="hljs-string">'{'</span>,
        <span class="hljs-string">'    vec2 fenc = enc*4.0-2.0;'</span>,
        <span class="hljs-string">'    float f = dot(fenc,fenc);'</span>,
        <span class="hljs-string">'    float g = sqrt(1.0-f/4.0);'</span>,
        <span class="hljs-string">'    vec3 n;'</span>,
        <span class="hljs-string">'    n.xy = fenc*g;'</span>,
        <span class="hljs-string">'    n.z = 1.0-f/2.0;'</span>,
        <span class="hljs-string">'    return n;'</span>,
        <span class="hljs-string">'}'</span>,
        <span class="hljs-string">''</span>
    ].join( <span class="hljs-string">'\n'</span> );

    Composer.Filter.Helper = {
        getOrCreatePascalCoefficients: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> cache = Composer.Filter.Helper.getOrCreatePascalCoefficients.cache;
            <span class="hljs-keyword">if</span> ( cache !== <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">return</span> cache;
            }

            cache = ( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( kernelSize )</span> {</span>
                <span class="hljs-keyword">var</span> pascalTriangle = [
                    [ <span class="hljs-number">1</span> ]
                ];
                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; ( kernelSize - <span class="hljs-number">1</span> ); j++ ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>var sum = Math.pow( 2, j );</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> currentRow = pascalTriangle[ j ];
                    <span class="hljs-keyword">var</span> currentRowSize = currentRow.length;

                    <span class="hljs-keyword">var</span> nextRowSize = currentRowSize + <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">var</span> nextRow = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>( currentRowSize );
                    nextRow[ <span class="hljs-number">0</span> ] = <span class="hljs-number">1.0</span>;
                    nextRow[ nextRowSize - <span class="hljs-number">1</span> ] = <span class="hljs-number">1.0</span>;

                    <span class="hljs-keyword">var</span> idx = <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> p = <span class="hljs-number">0</span>; p &lt; currentRowSize - <span class="hljs-number">1</span>; p++ ) {
                        <span class="hljs-keyword">var</span> val = ( currentRow[ p ] + currentRow[ p + <span class="hljs-number">1</span> ] );
                        nextRow[ idx++ ] = val;
                    }
                    pascalTriangle.push( nextRow );
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>compute real coef dividing by sum</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                ( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> a = <span class="hljs-number">0</span>; a &lt; pascalTriangle.length; a++ ) {
                        <span class="hljs-keyword">var</span> row = pascalTriangle[ a ];</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>var str = ‘’;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                        <span class="hljs-keyword">var</span> sum = <span class="hljs-built_in">Math</span>.pow( <span class="hljs-number">2</span>, a );
                        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; row.length; i++ ) {
                            row[ i ] = row[ i ] / sum;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>str += row[i].toString() + ‘ ‘;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>console.log(str);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    }
                } )();

                <span class="hljs-keyword">return</span> pascalTriangle;
            } )( <span class="hljs-number">20</span> );
            Composer.Filter.Helper.getOrCreatePascalCoefficients.cache = cache;
            <span class="hljs-keyword">return</span> cache;
        }
    };

    Composer.Filter.Custom = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( fragmentShader, uniforms )</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">this</span>._fragmentShader = fragmentShader;
        <span class="hljs-keyword">this</span>._uniforms = uniforms;
        <span class="hljs-keyword">this</span>._vertexShader = Composer.Filter.defaultVertexShader;
    };

    Composer.Filter.Custom.prototype = MACROUTILS.objectInehrit( Composer.Filter.prototype, {
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, <span class="hljs-keyword">this</span>._vertexShader ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, <span class="hljs-keyword">this</span>._fragmentShader ) );

            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._uniforms ) {
                <span class="hljs-keyword">var</span> unitIndex = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>._fragmentShader.match( <span class="hljs-regexp">/uniform\s+\w+\s+\w+/g</span> );
                <span class="hljs-keyword">if</span> ( r !== <span class="hljs-literal">null</span> ) {
                    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = r.length; i &lt; l; i++ ) {
                        <span class="hljs-keyword">var</span> match = r[ i ].match( <span class="hljs-regexp">/uniform\s+(\w+)\s+(\w+)/</span> );
                        <span class="hljs-keyword">var</span> uniformType = match[ <span class="hljs-number">1</span> ];
                        <span class="hljs-keyword">var</span> uniformName = match[ <span class="hljs-number">2</span> ];
                        <span class="hljs-keyword">var</span> uniform;

                        <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._uniforms[ uniformName ] !== <span class="hljs-literal">undefined</span> ) {
                            <span class="hljs-keyword">var</span> uniformValue = <span class="hljs-keyword">this</span>._uniforms[ uniformName ];
                            <span class="hljs-keyword">if</span> ( uniformType.search( <span class="hljs-string">'sampler'</span> ) !== -<span class="hljs-number">1</span> ) {
                                <span class="hljs-keyword">this</span>._stateSet.setTextureAttributeAndModes( unitIndex, uniformValue );
                                uniform = Uniform.createInt1( unitIndex, uniformName );
                                unitIndex++;
                                <span class="hljs-keyword">this</span>._stateSet.addUniform( uniform );
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">if</span> ( Uniform.isUniform( uniformValue ) ) {
                                    uniform = uniformValue;
                                } <span class="hljs-keyword">else</span> {
                                    uniform = Uniform[ uniformType ]( <span class="hljs-keyword">this</span>._uniforms[ uniformName ], uniformName );
                                }
                                <span class="hljs-keyword">this</span>._stateSet.addUniform( uniform );
                            }
                        }
                    }
                }
            }
            <span class="hljs-keyword">this</span>._stateSet.setAttributeAndModes( program );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );



    Composer.Filter.AverageHBlur = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( nbSamplesOpt )</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">if</span> ( nbSamplesOpt === <span class="hljs-literal">undefined</span> ) {
            <span class="hljs-keyword">this</span>.setBlurSize( <span class="hljs-number">5</span> );
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.setBlurSize( nbSamplesOpt );
        }
        <span class="hljs-keyword">this</span>._pixelSize = <span class="hljs-number">1.0</span>;
    };

    Composer.Filter.AverageHBlur.prototype = MACROUTILS.objectInehrit( Composer.Filter.prototype, {
        setBlurSize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( nbSamples )</span> {</span>
            <span class="hljs-keyword">if</span> ( nbSamples % <span class="hljs-number">2</span> !== <span class="hljs-number">1</span> ) {
                nbSamples += <span class="hljs-number">1</span>;
            }
            <span class="hljs-keyword">this</span>._nbSamples = nbSamples;
            <span class="hljs-keyword">this</span>.dirty();
        },
        setPixelSize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">this</span>._pixelSize = value;
            <span class="hljs-keyword">this</span>.dirty();
        },
        getUVOffset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">'vec2(float('</span> + value + <span class="hljs-string">'), 0.0)/RenderSize[0];'</span>;
        },
        getShaderBlurKernel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> nbSamples = <span class="hljs-keyword">this</span>._nbSamples;
            <span class="hljs-keyword">var</span> kernel = [];
            kernel.push( <span class="hljs-string">' pixel = texture2D(Texture0, FragTexCoord0 );'</span> );
            kernel.push( <span class="hljs-string">' if (pixel.w == 0.0) { gl_FragColor = pixel; return; }'</span> );
            kernel.push( <span class="hljs-string">' vec2 offset;'</span> );
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">Math</span>.ceil( nbSamples / <span class="hljs-number">2</span> ); i++ ) {
                kernel.push( <span class="hljs-string">' offset = '</span> + <span class="hljs-keyword">this</span>.getUVOffset( i * <span class="hljs-keyword">this</span>._pixelSize ) );
                kernel.push( <span class="hljs-string">' pixel += texture2D(Texture0, FragTexCoord0 + offset);'</span> );
                kernel.push( <span class="hljs-string">' pixel += texture2D(Texture0, FragTexCoord0 - offset);'</span> );
            }
            kernel.push( <span class="hljs-string">' pixel /= float('</span> + nbSamples + <span class="hljs-string">');'</span> );
            <span class="hljs-keyword">return</span> kernel;
        },
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>var nbSamples = this._nbSamples;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> vtx = Composer.Filter.defaultVertexShader;
            <span class="hljs-keyword">var</span> fgt = [
                Composer.Filter.defaultFragmentShaderHeader,
                <span class="hljs-string">'uniform float width;'</span>,

                <span class="hljs-string">'void main (void)'</span>,
                <span class="hljs-string">'{'</span>,
                <span class="hljs-string">'  vec4 pixel;'</span>,
                <span class="hljs-keyword">this</span>.getShaderBlurKernel().join( <span class="hljs-string">'\n'</span> ),
                <span class="hljs-string">'  gl_FragColor = vec4(pixel);'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, vtx ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, fgt ) );

            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._stateSet.getUniform( <span class="hljs-string">'Texture0'</span> ) === <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">this</span>._stateSet.addUniform( Uniform.createInt1( <span class="hljs-number">0</span>, <span class="hljs-string">'Texture0'</span> ) );
            }
            <span class="hljs-keyword">this</span>._stateSet.setAttributeAndModes( program );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );


    Composer.Filter.AverageVBlur = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( nbSamplesOpt )</span> {</span>
        Composer.Filter.AverageHBlur.call( <span class="hljs-keyword">this</span>, nbSamplesOpt );
    };
    Composer.Filter.AverageVBlur.prototype = MACROUTILS.objectInehrit( Composer.Filter.AverageHBlur.prototype, {
        getUVOffset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">'vec2(0.0, float('</span> + value + <span class="hljs-string">'))/RenderSize[1];'</span>;
        }
    } );

    Composer.Filter.BilateralHBlur = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( options )</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );

        <span class="hljs-keyword">if</span> ( options === <span class="hljs-literal">undefined</span> ) {
            options = {};
        }

        <span class="hljs-keyword">var</span> nbSamplesOpt = options.nbSamples;
        <span class="hljs-keyword">var</span> depthTexture = options.depthTexture;
        <span class="hljs-keyword">var</span> radius = options.radius;

        <span class="hljs-keyword">if</span> ( nbSamplesOpt === <span class="hljs-literal">undefined</span> ) {
            <span class="hljs-keyword">this</span>.setBlurSize( <span class="hljs-number">5</span> );
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.setBlurSize( nbSamplesOpt );
        }
        <span class="hljs-keyword">this</span>._depthTexture = depthTexture;
        <span class="hljs-keyword">this</span>._radius = Uniform.createFloat( <span class="hljs-number">1.0</span>, <span class="hljs-string">'radius'</span> );
        <span class="hljs-keyword">this</span>._pixelSize = Uniform.createFloat( <span class="hljs-number">1.0</span>, <span class="hljs-string">'pixelSize'</span> );
        <span class="hljs-keyword">this</span>.setRadius( radius );
    };

    Composer.Filter.BilateralHBlur.prototype = MACROUTILS.objectInehrit( Composer.Filter.prototype, {
        setBlurSize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( nbSamples )</span> {</span>
            <span class="hljs-keyword">if</span> ( nbSamples % <span class="hljs-number">2</span> !== <span class="hljs-number">1</span> ) {
                nbSamples += <span class="hljs-number">1</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Notify.log(‘BlurSize ‘ + nbSamples);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>._nbSamples = nbSamples;
            <span class="hljs-keyword">this</span>.dirty();
        },
        setPixelSize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">this</span>._pixelSize.get()[ <span class="hljs-number">0</span> ] = value;
            <span class="hljs-keyword">this</span>._pixelSize.dirty();
        },
        setRadius: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( radius )</span> {</span>
            <span class="hljs-keyword">this</span>._radius.get()[ <span class="hljs-number">0</span> ] = radius; <span class="hljs-comment">// *2.0;</span>
            <span class="hljs-keyword">this</span>._radius.dirty();
        },
        getUVOffset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">'vec2(0.0, float('</span> + value + <span class="hljs-string">') * pixelSize )/RenderSize[1];'</span>;
        },
        getShaderBlurKernel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> nbSamples = <span class="hljs-keyword">this</span>._nbSamples;
            <span class="hljs-keyword">var</span> kernel = [];
            kernel.push( <span class="hljs-string">' pixel = texture2D(Texture0, FragTexCoord0 );'</span> );
            kernel.push( <span class="hljs-string">' if (pixel.w &lt;= 0.0001) { gl_FragColor = vec4(1.0); return; }'</span> );
            kernel.push( <span class="hljs-string">' vec2 offset, tmpUV;'</span> );
            kernel.push( <span class="hljs-string">' depth = getDepthValue(texture2D(Texture1, FragTexCoord0 ));'</span> );
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">Math</span>.ceil( nbSamples / <span class="hljs-number">2</span> ); i++ ) {
                kernel.push( <span class="hljs-string">' offset = '</span> + <span class="hljs-keyword">this</span>.getUVOffset( i ) );

                kernel.push( <span class="hljs-string">' tmpUV =  FragTexCoord0 + offset;'</span> );
                kernel.push( <span class="hljs-string">' tmpDepth = getDepthValue(texture2D(Texture1, tmpUV ));'</span> );
                kernel.push( <span class="hljs-string">' if ( abs(depth-tmpDepth) &lt; radius) {'</span> );
                kernel.push( <span class="hljs-string">'   pixel += texture2D(Texture0, tmpUV);'</span> );
                kernel.push( <span class="hljs-string">'   nbHits += 1.0;'</span> );
                kernel.push( <span class="hljs-string">' }'</span> );

                kernel.push( <span class="hljs-string">' tmpUV =  FragTexCoord0 - offset;'</span> );
                kernel.push( <span class="hljs-string">' tmpDepth = getDepthValue(texture2D(Texture1, tmpUV ));'</span> );
                kernel.push( <span class="hljs-string">' if ( abs(depth-tmpDepth) &lt; radius) {'</span> );
                kernel.push( <span class="hljs-string">'   pixel += texture2D(Texture0, tmpUV);'</span> );
                kernel.push( <span class="hljs-string">'   nbHits += 1.0;'</span> );
                kernel.push( <span class="hljs-string">' }'</span> );
            }
            kernel.push( <span class="hljs-string">' pixel /= nbHits;'</span> );
            <span class="hljs-keyword">return</span> kernel;
        },
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>var nbSamples = this._nbSamples;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> vtx = Composer.Filter.defaultVertexShader;
            <span class="hljs-keyword">var</span> fgt = [
                Composer.Filter.defaultFragmentShaderHeader,
                <span class="hljs-string">'uniform sampler2D Texture1;'</span>,
                <span class="hljs-string">'uniform float width;'</span>,
                <span class="hljs-string">'uniform mat4 projection;'</span>,
                <span class="hljs-string">'uniform float radius;'</span>,
                <span class="hljs-string">'uniform float pixelSize;'</span>,

                <span class="hljs-string">'float znear,zfar,zrange;'</span>,
                <span class="hljs-string">''</span>,
                Composer.Filter.shaderUtils,
                <span class="hljs-string">''</span>,
                <span class="hljs-string">'float getDepthValue(vec4 v) {'</span>,
                <span class="hljs-string">'  float depth = unpack4x8ToFloat(v);'</span>,
                <span class="hljs-string">'  depth = depth*zrange+znear;'</span>,
                <span class="hljs-string">'  return -depth;'</span>,
                <span class="hljs-string">'}'</span>,

                <span class="hljs-string">'void main (void)'</span>,
                <span class="hljs-string">'{'</span>,
                <span class="hljs-string">'  vec4 pixel;'</span>,
                <span class="hljs-string">'  float depth, tmpDepth;'</span>,
                <span class="hljs-string">'  znear = projection[3][2] / (projection[2][2]-1.0);'</span>,
                <span class="hljs-string">'  zfar = projection[3][2] / (projection[2][2]+1.0);'</span>,
                <span class="hljs-string">'  zrange = zfar-znear;'</span>,
                <span class="hljs-string">'  float nbHits = 1.0;'</span>,

                <span class="hljs-keyword">this</span>.getShaderBlurKernel().join( <span class="hljs-string">'\n'</span> ),
                <span class="hljs-string">'  gl_FragColor = vec4(pixel);'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, vtx ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, fgt ) );

            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._stateSet.getUniform( <span class="hljs-string">'Texture0'</span> ) === <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">this</span>._stateSet.addUniform( Uniform.createInt1( <span class="hljs-number">0</span>, <span class="hljs-string">'Texture0'</span> ) );
            }
            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._stateSet.getUniform( <span class="hljs-string">'Texture1'</span> ) === <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">this</span>._stateSet.addUniform( Uniform.createInt1( <span class="hljs-number">1</span>, <span class="hljs-string">'Texture1'</span> ) );
            }
            <span class="hljs-keyword">this</span>._stateSet.addUniform( <span class="hljs-keyword">this</span>._radius );
            <span class="hljs-keyword">this</span>._stateSet.addUniform( <span class="hljs-keyword">this</span>._pixelSize );
            <span class="hljs-keyword">this</span>._stateSet.setTextureAttributeAndModes( <span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>._depthTexture );
            <span class="hljs-keyword">this</span>._stateSet.setAttributeAndModes( program );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );

    Composer.Filter.BilateralVBlur = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( options )</span> {</span>
        Composer.Filter.BilateralHBlur.call( <span class="hljs-keyword">this</span>, options );
    };

    Composer.Filter.BilateralVBlur.prototype = MACROUTILS.objectInehrit( Composer.Filter.BilateralHBlur.prototype, {
        getUVOffset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">'vec2(float('</span> + value + <span class="hljs-string">')*pixelSize,0.0)/RenderSize[0];'</span>;
        }
    } );</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>InputTexture is a fake filter to setup the first texture
in the composer pipeline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Composer.Filter.InputTexture = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( texture )</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">this</span>._stateSet.setTextureAttributeAndModes( <span class="hljs-number">0</span>, texture );
    };
    Composer.Filter.InputTexture.prototype = MACROUTILS.objectInehrit( Composer.Filter.prototype, {
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Operate a Gaussian horizontal blur</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Composer.Filter.HBlur = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( nbSamplesOpt )</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">if</span> ( nbSamplesOpt === <span class="hljs-literal">undefined</span> ) {
            <span class="hljs-keyword">this</span>.setBlurSize( <span class="hljs-number">5</span> );
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.setBlurSize( nbSamplesOpt );
        }
    };

    Composer.Filter.HBlur.prototype = MACROUTILS.objectInehrit( Composer.Filter.prototype, {
        setBlurSize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( nbSamples )</span> {</span>
            <span class="hljs-keyword">if</span> ( nbSamples % <span class="hljs-number">2</span> !== <span class="hljs-number">1</span> ) {
                nbSamples += <span class="hljs-number">1</span>;
            }
            <span class="hljs-keyword">this</span>._nbSamples = nbSamples;
            <span class="hljs-keyword">this</span>.dirty();
        },
        getUVOffset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">'vec2(float('</span> + value + <span class="hljs-string">'), 0.0)/RenderSize[0];'</span>;
        },
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> nbSamples = <span class="hljs-keyword">this</span>._nbSamples;
            <span class="hljs-keyword">var</span> vtx = Composer.Filter.defaultVertexShader;
            <span class="hljs-keyword">var</span> pascal = Composer.Filter.Helper.getOrCreatePascalCoefficients();
            <span class="hljs-keyword">var</span> weights = pascal[ nbSamples - <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">var</span> start = <span class="hljs-built_in">Math</span>.floor( nbSamples / <span class="hljs-number">2.0</span> );
            <span class="hljs-keyword">var</span> kernel = [];
            kernel.push( <span class="hljs-string">' pixel += float('</span> + weights[ start ] + <span class="hljs-string">')*texture2D(Texture0, FragTexCoord0 ).rgb;'</span> );
            <span class="hljs-keyword">var</span> offset = <span class="hljs-number">1</span>;
            kernel.push( <span class="hljs-string">' vec2 offset;'</span> );
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = start + <span class="hljs-number">1</span>; i &lt; nbSamples; i++ ) {
                <span class="hljs-keyword">var</span> weight = weights[ i ];
                kernel.push( <span class="hljs-string">' offset = '</span> + <span class="hljs-keyword">this</span>.getUVOffset( i ) );
                offset++;
                kernel.push( <span class="hljs-string">' pixel += '</span> + weight + <span class="hljs-string">'*texture2D(Texture0, FragTexCoord0 + offset).rgb;'</span> );
                kernel.push( <span class="hljs-string">' pixel += '</span> + weight + <span class="hljs-string">'*texture2D(Texture0, FragTexCoord0 - offset).rgb;'</span> );
            }

            <span class="hljs-keyword">var</span> fgt = [
                Composer.Filter.defaultFragmentShaderHeader,
                <span class="hljs-string">'uniform float width;'</span>,

                <span class="hljs-string">'void main (void)'</span>,
                <span class="hljs-string">'{'</span>,
                <span class="hljs-string">'  vec3 pixel;'</span>,
                kernel.join( <span class="hljs-string">'\n'</span> ),
                <span class="hljs-string">'  gl_FragColor = vec4(pixel,1.0);'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, vtx ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, fgt ) );

            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._stateSet.getUniform( <span class="hljs-string">'Texture0'</span> ) === <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">this</span>._stateSet.addUniform( Uniform.createInt1( <span class="hljs-number">0</span>, <span class="hljs-string">'Texture0'</span> ) );
            }
            <span class="hljs-keyword">this</span>._stateSet.setAttributeAndModes( program );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Operate a Gaussian vertical blur</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Composer.Filter.VBlur = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( <span class="hljs-comment">/*nbSamplesOpt*/</span> )</span> {</span>
        Composer.Filter.HBlur.call( <span class="hljs-keyword">this</span> );
    };

    Composer.Filter.VBlur.prototype = MACROUTILS.objectInehrit( Composer.Filter.HBlur.prototype, {
        getUVOffset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">'vec2(0.0, float('</span> + value + <span class="hljs-string">'))/RenderSize[1];'</span>;
        }
    } );</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Sobel filter
<a href="http://en.wikipedia.org/wiki/Sobel_operator">http://en.wikipedia.org/wiki/Sobel_operator</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Composer.Filter.SobelFilter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">this</span>._color = Uniform.createFloat3( [ <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span> ], <span class="hljs-string">'color'</span> );
        <span class="hljs-keyword">this</span>._factor = Uniform.createFloat( <span class="hljs-number">1.0</span>, <span class="hljs-string">'factor'</span> );
    };

    Composer.Filter.SobelFilter.prototype = MACROUTILS.objectInehrit( Composer.Filter.prototype, {
        setColor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( color )</span> {</span>
            <span class="hljs-keyword">this</span>._color.get()[ <span class="hljs-number">0</span> ] = color[ <span class="hljs-number">0</span> ];
            <span class="hljs-keyword">this</span>._color.get()[ <span class="hljs-number">1</span> ] = color[ <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">this</span>._color.get()[ <span class="hljs-number">2</span> ] = color[ <span class="hljs-number">2</span> ];
            <span class="hljs-keyword">this</span>._color.dirty();
        },
        setFactor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( f )</span> {</span>
            <span class="hljs-keyword">this</span>._factor.get()[ <span class="hljs-number">0</span> ] = f;
            <span class="hljs-keyword">this</span>._factor.dirty();
        },
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> stateSet = <span class="hljs-keyword">this</span>._stateSet;
            <span class="hljs-keyword">var</span> vtx = Composer.Filter.defaultVertexShader;
            <span class="hljs-keyword">var</span> fgt = [
                <span class="hljs-string">''</span>,
                Composer.Filter.defaultFragmentShaderHeader,
                <span class="hljs-string">'uniform vec3 color;'</span>,
                <span class="hljs-string">'uniform float factor;'</span>,
                <span class="hljs-string">'void main (void)'</span>,
                <span class="hljs-string">'{'</span>,
                <span class="hljs-string">'  float fac0 = 2.0;'</span>,
                <span class="hljs-string">'  float fac1 = 1.0;'</span>,
                <span class="hljs-string">'  float offsetx = 1.0/RenderSize[0];'</span>,
                <span class="hljs-string">'  float offsety = 1.0/RenderSize[1];'</span>,
                <span class="hljs-string">'  vec4 texel0 = texture2D(Texture0, FragTexCoord0 + vec2(offsetx, offsety));'</span>,
                <span class="hljs-string">'  vec4 texel1 = texture2D(Texture0, FragTexCoord0 + vec2(offsetx, 0.0));'</span>,
                <span class="hljs-string">'  vec4 texel2 = texture2D(Texture0, FragTexCoord0 + vec2(offsetx, -offsety));'</span>,
                <span class="hljs-string">'  vec4 texel3 = texture2D(Texture0, FragTexCoord0 + vec2(0.0, -offsety));'</span>,
                <span class="hljs-string">'  vec4 texel4 = texture2D(Texture0, FragTexCoord0 + vec2(-offsetx, -offsety));'</span>,
                <span class="hljs-string">'  vec4 texel5 = texture2D(Texture0, FragTexCoord0 + vec2(-offsetx, 0.0));'</span>,
                <span class="hljs-string">'  vec4 texel6 = texture2D(Texture0, FragTexCoord0 + vec2(-offsetx, offsety));'</span>,
                <span class="hljs-string">'  vec4 texel7 = texture2D(Texture0, FragTexCoord0 + vec2(0.0, offsety));'</span>,
                <span class="hljs-string">'  vec4 rowx = -fac0*texel5 + fac0*texel1 +  -fac1*texel6 + fac1*texel0 + -fac1*texel4 + fac1*texel2;'</span>,
                <span class="hljs-string">'  vec4 rowy = -fac0*texel3 + fac0*texel7 +  -fac1*texel4 + fac1*texel6 + -fac1*texel2 + fac1*texel0;'</span>,
                <span class="hljs-string">'  float mag = sqrt(dot(rowy,rowy)+dot(rowx,rowx));'</span>,
                <span class="hljs-string">'  if (mag &lt; 1.0/255.0) { discard; return; }'</span>,
                <span class="hljs-string">'  mag *= factor;'</span>,
                <span class="hljs-string">'  mag = min(1.0, mag);'</span>,
                <span class="hljs-string">'  gl_FragColor = vec4(color*mag,mag);'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, vtx ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, fgt ) );

            stateSet.setAttributeAndModes( program );
            stateSet.addUniform( <span class="hljs-keyword">this</span>._color );
            stateSet.addUniform( <span class="hljs-keyword">this</span>._factor );
            stateSet.addUniform( Uniform.createInt1( <span class="hljs-number">0</span>, <span class="hljs-string">'Texture0'</span> ) );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );



    Composer.Filter.BlendMix = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">var</span> texture0, texture1, mixValue;
        <span class="hljs-keyword">var</span> unit0 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> unit1 = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">var</span> stateSet = <span class="hljs-keyword">this</span>._stateSet;
        <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">3</span> ) {
            texture0 = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">0</span> ];
            texture1 = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">1</span> ];
            mixValue = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">2</span> ];
            unit0 = <span class="hljs-number">1</span>;
            unit1 = <span class="hljs-number">2</span>;
            stateSet.setTextureAttributeAndModes( unit0, texture0 );
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">2</span> ) {
            texture1 = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">0</span> ];
            mixValue = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">1</span> ];
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span> ) {
            texture1 = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">0</span> ];
            mixValue = <span class="hljs-number">0.5</span>;
        }
        stateSet.setTextureAttributeAndModes( unit1, texture1 );
        stateSet.addUniform( Uniform.createInt1( unit0, <span class="hljs-string">'Texture0'</span> ) );
        stateSet.addUniform( Uniform.createInt1( unit1, <span class="hljs-string">'Texture1'</span> ) );
        <span class="hljs-keyword">this</span>._mixValueUniform = Uniform.createFloat1( mixValue, <span class="hljs-string">'MixValue'</span> );
        stateSet.addUniform( <span class="hljs-keyword">this</span>._mixValueUniform );
    };

    Composer.Filter.BlendMix = MACROUTILS.objectInehrit( Composer.Filter.prototype, {
        getBlendFactorUniform: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._mixValueUniform;
        },

        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> stateSet = <span class="hljs-keyword">this</span>._stateSet;
            <span class="hljs-keyword">var</span> vtx = Composer.Filter.defaultVertexShader;
            <span class="hljs-keyword">var</span> fgt = [
                <span class="hljs-string">''</span>,
                Composer.Filter.defaultFragmentShaderHeader,
                <span class="hljs-string">'uniform sampler2D Texture1;'</span>,
                <span class="hljs-string">'uniform float MixValue;'</span>,

                <span class="hljs-string">'void main (void)'</span>,
                <span class="hljs-string">'{'</span>,
                <span class="hljs-string">'  gl_FragColor = mix(texture2D(Texture0,FragTexCoord0), texture2D(Texture1,FragTexCoord0),MixValue);'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, vtx ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, fgt ) );

            stateSet.setAttributeAndModes( program );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );


    Composer.Filter.BlendMultiply = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">var</span> stateSet = <span class="hljs-keyword">this</span>._stateSet;
        <span class="hljs-keyword">var</span> texture0, texture1;
        <span class="hljs-keyword">var</span> unit0 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> unit1 = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">2</span> ) {
            texture0 = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">0</span> ];
            texture1 = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">1</span> ];
            unit0 = <span class="hljs-number">1</span>;
            unit0 = <span class="hljs-number">2</span>;
            stateSet.setTextureAttributeAndModes( unit0, texture0 );
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span> ) {
            texture1 = <span class="hljs-built_in">arguments</span>[ <span class="hljs-number">0</span> ];
        }
        stateSet.setTextureAttributeAndModes( unit1, texture1 );
        stateSet.addUniform( Uniform.createInt1( unit0, <span class="hljs-string">'Texture0'</span> ) );
        stateSet.addUniform( Uniform.createInt1( unit1, <span class="hljs-string">'Texture1'</span> ) );
    };

    Composer.Filter.BlendMultiply.prototype = MACROUTILS.objectInehrit( Composer.Filter.prototype, {
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> vtx = Composer.Filter.defaultVertexShader;
            <span class="hljs-keyword">var</span> fgt = [
                <span class="hljs-string">''</span>,
                Composer.Filter.defaultFragmentShaderHeader,
                <span class="hljs-string">'uniform sampler2D Texture1;'</span>,
                <span class="hljs-string">'uniform float MixValue;'</span>,

                <span class="hljs-string">'void main (void)'</span>,
                <span class="hljs-string">'{'</span>,
                <span class="hljs-string">'  gl_FragColor = texture2D(Texture0,FragTexCoord0)*texture2D(Texture1,FragTexCoord0);'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, vtx ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, fgt ) );

            <span class="hljs-keyword">this</span>._stateSet.setAttributeAndModes( program );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );

    Composer.Filter.SSAO = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( options )</span> {</span>
        Composer.Filter.call( <span class="hljs-keyword">this</span> );

        <span class="hljs-keyword">var</span> stateSet = <span class="hljs-keyword">this</span>._stateSet;
        <span class="hljs-keyword">var</span> nbSamples = <span class="hljs-number">16</span>;
        <span class="hljs-keyword">var</span> radius = <span class="hljs-number">0.05</span>;
        <span class="hljs-keyword">if</span> ( options !== <span class="hljs-literal">undefined</span> ) {
            <span class="hljs-keyword">if</span> ( options.nbSamples !== <span class="hljs-literal">undefined</span> )
                nbSamples = options.nbSamples;

            <span class="hljs-keyword">if</span> ( options.radius !== <span class="hljs-literal">undefined</span> )
                radius = options.radius;
        }

        <span class="hljs-keyword">var</span> textureNormal = options.normal;
        <span class="hljs-keyword">var</span> texturePosition = options.position;
        <span class="hljs-keyword">this</span>._radius = radius;
        <span class="hljs-keyword">this</span>._nbSamples = nbSamples;
        <span class="hljs-keyword">this</span>._noiseTextureSize = <span class="hljs-number">16</span>;
        <span class="hljs-keyword">this</span>._sceneRadius = <span class="hljs-number">2.0</span>;

        stateSet.addUniform( Uniform.createFloat1( <span class="hljs-number">1.0</span>, <span class="hljs-string">'Power'</span> ) );
        stateSet.addUniform( Uniform.createFloat1( radius, <span class="hljs-string">'Radius'</span> ) );
        stateSet.addUniform( Uniform.createInt1( <span class="hljs-number">0</span>, <span class="hljs-string">'Texture0'</span> ) );
        stateSet.addUniform( Uniform.createInt1( <span class="hljs-number">1</span>, <span class="hljs-string">'Texture1'</span> ) );
        stateSet.addUniform( Uniform.createInt1( <span class="hljs-number">2</span>, <span class="hljs-string">'Texture2'</span> ) );
        stateSet.addUniform( Uniform.createFloat1( <span class="hljs-number">0.1</span>, <span class="hljs-string">'AngleLimit'</span> ) );

        <span class="hljs-keyword">var</span> w = textureNormal.getWidth();
        <span class="hljs-keyword">var</span> h = textureNormal.getHeight();
        <span class="hljs-keyword">this</span>._size = [ w, h ];

        stateSet.setTextureAttributeAndModes( <span class="hljs-number">0</span>, textureNormal );
        stateSet.setTextureAttributeAndModes( <span class="hljs-number">1</span>, texturePosition );

        <span class="hljs-keyword">this</span>.initNoise();

    };

    Composer.Filter.SSAO.prototype = MACROUTILS.objectInehrit( Composer.Filter.prototype, {

        initNoise: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> sizeNoise = <span class="hljs-keyword">this</span>._noiseTextureSize;
            <span class="hljs-keyword">var</span> noise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>( sizeNoise * sizeNoise * <span class="hljs-number">3</span> );
            ( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( array )</span> {</span>
                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; sizeNoise * sizeNoise; i++ ) {
                    <span class="hljs-keyword">var</span> x, y, z;
                    x = <span class="hljs-number">2.0</span> * ( <span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span> );
                    y = <span class="hljs-number">2.0</span> * ( <span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span> );
                    z = <span class="hljs-number">0.0</span>;

                    <span class="hljs-keyword">var</span> n = Vec3.normalize( [ x, y, z ], [] );
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">0</span> ] = <span class="hljs-number">255</span> * ( n[ <span class="hljs-number">0</span> ] * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span> );
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">1</span> ] = <span class="hljs-number">255</span> * ( n[ <span class="hljs-number">1</span> ] * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span> );
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">2</span> ] = <span class="hljs-number">255</span> * ( n[ <span class="hljs-number">2</span> ] * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span> );
                }
            } )( noise );

            <span class="hljs-keyword">var</span> noiseTexture = <span class="hljs-keyword">new</span> Texture();
            noiseTexture.setWrapS( <span class="hljs-string">'REPEAT'</span> );
            noiseTexture.setWrapT( <span class="hljs-string">'REPEAT'</span> );
            noiseTexture.setMinFilter( <span class="hljs-string">'NEAREST'</span> );
            noiseTexture.setMagFilter( <span class="hljs-string">'NEAREST'</span> );

            noiseTexture.setTextureSize( sizeNoise, sizeNoise );
            noiseTexture.setImage( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>( noise ), <span class="hljs-string">'RGB'</span> );
            <span class="hljs-keyword">this</span>._noiseTexture = noiseTexture;
        },
        setSceneRadius: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">this</span>._sceneRadius = value;
            <span class="hljs-keyword">this</span>.dirty();
        },
        setAngleLimit: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">var</span> uniform = <span class="hljs-keyword">this</span>._stateSet.getUniform( <span class="hljs-string">'AngleLimit'</span> );
            uniform.get()[ <span class="hljs-number">0</span> ] = value;
            uniform.dirty();
        },
        setNbSamples: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">if</span> ( value === <span class="hljs-keyword">this</span>._nbSamples ) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">this</span>._nbSamples = <span class="hljs-built_in">Math</span>.floor( value );
            <span class="hljs-keyword">this</span>.dirty();
        },
        setRadius: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">var</span> uniform = <span class="hljs-keyword">this</span>._stateSet.getUniform( <span class="hljs-string">'Radius'</span> );
            uniform.get()[ <span class="hljs-number">0</span> ] = value;
            uniform.dirty();
        },
        setPower: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> {</span>
            <span class="hljs-keyword">var</span> uniform = <span class="hljs-keyword">this</span>._stateSet.getUniform( <span class="hljs-string">'Power'</span> );
            uniform.get()[ <span class="hljs-number">0</span> ] = value;
            uniform.dirty();
        },
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> stateSet = <span class="hljs-keyword">this</span>._stateSet;
            <span class="hljs-keyword">var</span> nbSamples = <span class="hljs-keyword">this</span>._nbSamples;
            <span class="hljs-keyword">var</span> kernel = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>( nbSamples * <span class="hljs-number">4</span> );
            ( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( array )</span> {</span>
                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nbSamples; i++ ) {
                    <span class="hljs-keyword">var</span> x, y, z;
                    x = <span class="hljs-number">2.0</span> * ( <span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span> );
                    y = <span class="hljs-number">2.0</span> * ( <span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span> );
                    z = <span class="hljs-built_in">Math</span>.random();

                    <span class="hljs-keyword">var</span> v = Vec3.normalize( [ x, y, z ], [] );
                    <span class="hljs-keyword">var</span> scale = <span class="hljs-built_in">Math</span>.max( i / nbSamples, <span class="hljs-number">0.1</span> );
                    scale = <span class="hljs-number">0.1</span> + ( <span class="hljs-number">1.0</span> - <span class="hljs-number">0.1</span> ) * ( scale * scale );
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">0</span> ] = v[ <span class="hljs-number">0</span> ];
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">1</span> ] = v[ <span class="hljs-number">1</span> ];
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">2</span> ] = v[ <span class="hljs-number">2</span> ];
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">3</span> ] = scale;
                }
            } )( kernel );


            stateSet.setTextureAttributeAndModes( <span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>._noiseTexture );
            <span class="hljs-keyword">var</span> uniform = stateSet.getUniform( <span class="hljs-string">'noiseSampling'</span> );
            <span class="hljs-keyword">if</span> ( uniform === <span class="hljs-literal">undefined</span> ) {
                uniform = Uniform.createFloat2( [ <span class="hljs-keyword">this</span>._size[ <span class="hljs-number">0</span> ] / <span class="hljs-keyword">this</span>._noiseTextureSize, <span class="hljs-keyword">this</span>._size[ <span class="hljs-number">1</span> ] / <span class="hljs-keyword">this</span>._noiseTextureSize ], <span class="hljs-string">'noiseSampling'</span> );
                stateSet.addUniform( uniform );
            } <span class="hljs-keyword">else</span> {
                uniform.set( [ <span class="hljs-keyword">this</span>._size[ <span class="hljs-number">0</span> ] / <span class="hljs-keyword">this</span>._noiseTextureSize, <span class="hljs-keyword">this</span>._size[ <span class="hljs-number">1</span> ] / <span class="hljs-keyword">this</span>._noiseTextureSize ] );
                uniform.dirty();
            }
            <span class="hljs-keyword">var</span> vertexshader = [
                <span class="hljs-string">''</span>,
                <span class="hljs-string">'#ifdef GL_ES'</span>,
                <span class="hljs-string">'precision highp float;'</span>,
                <span class="hljs-string">'#endif'</span>,
                <span class="hljs-string">'attribute vec3 Vertex;'</span>,
                <span class="hljs-string">'attribute vec2 TexCoord0;'</span>,
                <span class="hljs-string">'varying vec2 FragTexCoord0;'</span>,
                <span class="hljs-string">'uniform mat4 ModelViewMatrix;'</span>,
                <span class="hljs-string">'uniform mat4 ProjectionMatrix;'</span>,
                <span class="hljs-string">'void main(void) {'</span>,
                <span class="hljs-string">'  gl_Position = ProjectionMatrix * ModelViewMatrix * vec4(Vertex,1.0);'</span>,
                <span class="hljs-string">'  FragTexCoord0 = TexCoord0;'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> kernelglsl = [];
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nbSamples; i++ ) {
                kernelglsl.push( <span class="hljs-string">'kernel['</span> + i + <span class="hljs-string">'] = vec4('</span> + kernel[ i * <span class="hljs-number">3</span> ] + <span class="hljs-string">','</span> + kernel[ i * <span class="hljs-number">3</span> + <span class="hljs-number">1</span> ] + <span class="hljs-string">', '</span> + kernel[ i * <span class="hljs-number">3</span> + <span class="hljs-number">2</span> ] + <span class="hljs-string">', '</span> + kernel[ i * <span class="hljs-number">3</span> + <span class="hljs-number">3</span> ] + <span class="hljs-string">');'</span> );
            }
            kernelglsl = kernelglsl.join( <span class="hljs-string">'\n'</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>var ssaoRadiusMin = this._sceneRadius <em> 0.002;
var ssaoRadiusMax = this._sceneRadius </em> 0.05;
var ssaoRadiusStep = ( ssaoRadiusMax - ssaoRadiusMin ) / 200.0;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> fragmentshader = [
                <span class="hljs-string">''</span>,
                Composer.Filter.defaultFragmentShaderHeader,
                <span class="hljs-string">'uniform sampler2D Texture1;'</span>,
                <span class="hljs-string">'uniform sampler2D Texture2;'</span>,
                <span class="hljs-string">'uniform mat4 projection;'</span>,
                <span class="hljs-string">'uniform vec2 noiseSampling;'</span>,
                <span class="hljs-string">'uniform float Power;'</span>, <span class="hljs-comment">//'+ '{ 'min': 0.1, 'max': 16.0, 'step': 0.1, 'value': 1.0 }',</span>
                <span class="hljs-string">'uniform float Radius;'</span>, <span class="hljs-comment">//'+ '{ 'min': ' + ssaoRadiusMin +', 'max': ' + ssaoRadiusMax + ', 'step': '+ ssaoRadiusStep + ', 'value': 0.01 }',</span>
                <span class="hljs-string">'uniform float AngleLimit;'</span>,
                <span class="hljs-string">'#define NB_SAMPLES '</span> + <span class="hljs-keyword">this</span>._nbSamples,
                <span class="hljs-string">'float depth;'</span>,
                <span class="hljs-string">'vec3 normal;'</span>,
                <span class="hljs-string">'vec4 position;'</span>,
                <span class="hljs-string">'vec4 kernel['</span> + nbSamples + <span class="hljs-string">'];'</span>,


                <span class="hljs-string">'mat3 computeBasis()'</span>,
                <span class="hljs-string">'{'</span>,
                <span class="hljs-string">'  vec2 uvrand = FragTexCoord0*noiseSampling;'</span>,
                <span class="hljs-string">'  vec3 rvec = texture2D(Texture2, uvrand*2.0).xyz*2.0-vec3(1.0);'</span>,
                <span class="hljs-string">'  vec3 tangent = normalize(rvec - normal * dot(rvec, normal));'</span>,
                <span class="hljs-string">'  vec3 bitangent = cross(normal, tangent);'</span>,
                <span class="hljs-string">'  mat3 tbn = mat3(tangent, bitangent, normal);'</span>,
                <span class="hljs-string">'  return tbn;'</span>,
                <span class="hljs-string">'}'</span>,

                <span class="hljs-string">'void main (void)'</span>,
                <span class="hljs-string">'{'</span>,
                kernelglsl,
                <span class="hljs-string">'  position = texture2D(Texture1, FragTexCoord0);'</span>,
                <span class="hljs-string">'  vec4 p = texture2D(Texture0, FragTexCoord0);'</span>,
                <span class="hljs-string">'  depth = p.w;'</span>,
                <span class="hljs-string">'  normal = vec3(p);'</span>,
                <span class="hljs-string">'  if ( position.w == 0.0) {'</span>,
                <span class="hljs-string">'     gl_FragColor = vec4(1.0,1.0,1.0,0.0);'</span>,
                <span class="hljs-string">'     return;'</span>,
                <span class="hljs-string">'  }'</span>,
                <span class="hljs-string">''</span>,
                <span class="hljs-string">' mat3 tbn = computeBasis();'</span>,
                <span class="hljs-string">' float occlusion = 0.0;'</span>,
                <span class="hljs-string">' for (int i = 0; i &lt; NB_SAMPLES; i++) {'</span>,
                <span class="hljs-string">'    vec3 vecKernel = vec3(kernel[i]);'</span>,
                <span class="hljs-string">'    vecKernel[2] = max(AngleLimit,vecKernel[2]);'</span>,
                <span class="hljs-string">'    vec3 sample = tbn * vecKernel;'</span>,
                <span class="hljs-string">'    vec3 dir = sample;'</span>,
                <span class="hljs-string">'    float w = dot(dir, normal);'</span>,
                <span class="hljs-string">'    float dist = 1.0-kernel[i].w;'</span>,
                <span class="hljs-string">'    w *= dist*dist*Power;'</span>,
                <span class="hljs-string">'    sample = dir * float(Radius) + position.xyz;'</span>,

                <span class="hljs-string">'    vec4 offset = projection * vec4(sample,1.0);'</span>,
                <span class="hljs-string">'    offset.xy /= offset.w;'</span>,
                <span class="hljs-string">'    offset.xy = offset.xy * 0.5 + 0.5;'</span>,

                <span class="hljs-string">'    float sample_depth = texture2D(Texture1, offset.xy).z;'</span>,
                <span class="hljs-string">'    float range_check = abs(sample.z - sample_depth) &lt; float(Radius) ? 1.0 : 0.0;'</span>,
                <span class="hljs-string">'    occlusion += (sample_depth &gt; sample.z ? 1.0 : 0.0) * range_check*w;'</span>,

                <span class="hljs-string">' }'</span>,
                <span class="hljs-string">' occlusion = 1.0 - (occlusion / float(NB_SAMPLES));'</span>,
                <span class="hljs-string">' gl_FragColor = vec4(vec3(occlusion),1.0);'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, vertexshader ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, fragmentshader ) );

            stateSet.setAttributeAndModes( program );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );



    Composer.Filter.SSAO8 = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( options )</span> {</span>
        Composer.Filter.SSAO.call( <span class="hljs-keyword">this</span>, options );
    };

    Composer.Filter.SSAO8.prototype = MACROUTILS.objectInehrit( Composer.Filter.SSAO.prototype, {
        buildGeometry: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( quad )</span> {</span>
            quad.getAttributes().TexCoord1 = <span class="hljs-keyword">this</span>._texCoord1;
            <span class="hljs-keyword">return</span> quad;
        },
        build: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> stateSet = <span class="hljs-keyword">this</span>._stateSet;
            <span class="hljs-keyword">var</span> nbSamples = <span class="hljs-keyword">this</span>._nbSamples;
            <span class="hljs-keyword">var</span> kernel = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>( nbSamples * <span class="hljs-number">4</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>var angleLimit = this._angleLimit;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            ( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( array )</span> {</span>
                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nbSamples; i++ ) {
                    <span class="hljs-keyword">var</span> x, y, z;
                    x = <span class="hljs-number">2.0</span> * ( <span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span> );
                    y = <span class="hljs-number">2.0</span> * ( <span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span> );
                    z = <span class="hljs-built_in">Math</span>.random();

                    <span class="hljs-keyword">var</span> v = Vec3.normalize( [ x, y, z ], [] );
                    <span class="hljs-keyword">var</span> scale = <span class="hljs-built_in">Math</span>.max( i / nbSamples, <span class="hljs-number">0.1</span> );
                    scale = <span class="hljs-number">0.1</span> + ( <span class="hljs-number">1.0</span> - <span class="hljs-number">0.1</span> ) * ( scale * scale );
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">0</span> ] = v[ <span class="hljs-number">0</span> ];
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">1</span> ] = v[ <span class="hljs-number">1</span> ];
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">2</span> ] = v[ <span class="hljs-number">2</span> ];
                    array[ i * <span class="hljs-number">3</span> + <span class="hljs-number">3</span> ] = scale;
                }
            } )( kernel );</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>var sizeNoise = this._noiseTextureSize;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            stateSet.setTextureAttributeAndModes( <span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>._noiseTexture );
            <span class="hljs-keyword">var</span> uniform = stateSet.getUniform( <span class="hljs-string">'noiseSampling'</span> );
            <span class="hljs-keyword">if</span> ( uniform === <span class="hljs-literal">undefined</span> ) {
                uniform = Uniform.createFloat2( [ <span class="hljs-keyword">this</span>._size[ <span class="hljs-number">0</span> ] / <span class="hljs-keyword">this</span>._noiseTextureSize, <span class="hljs-keyword">this</span>._size[ <span class="hljs-number">1</span> ] / <span class="hljs-keyword">this</span>._noiseTextureSize ], <span class="hljs-string">'noiseSampling'</span> );
                stateSet.addUniform( uniform );
            } <span class="hljs-keyword">else</span> {
                uniform.set( [ <span class="hljs-keyword">this</span>._size[ <span class="hljs-number">0</span> ] / <span class="hljs-keyword">this</span>._noiseTextureSize, <span class="hljs-keyword">this</span>._size[ <span class="hljs-number">1</span> ] / <span class="hljs-keyword">this</span>._noiseTextureSize ] );
                uniform.dirty();
            }
            <span class="hljs-keyword">var</span> vertexshader = [
                <span class="hljs-string">''</span>,
                <span class="hljs-string">'#ifdef GL_ES'</span>,
                <span class="hljs-string">'precision highp float;'</span>,
                <span class="hljs-string">'#endif'</span>,
                <span class="hljs-string">'attribute vec3 Vertex;'</span>,
                <span class="hljs-string">'attribute vec2 TexCoord0;'</span>,
                <span class="hljs-string">'attribute vec3 TexCoord1;'</span>,
                <span class="hljs-string">'varying vec2 FragTexCoord0;'</span>,
                <span class="hljs-string">'varying vec3 FragTexCoord1;'</span>,
                <span class="hljs-string">'uniform mat4 ModelViewMatrix;'</span>,
                <span class="hljs-string">'uniform mat4 ProjectionMatrix;'</span>,
                <span class="hljs-string">'void main(void) {'</span>,
                <span class="hljs-string">'  gl_Position = ProjectionMatrix * ModelViewMatrix * vec4(Vertex,1.0);'</span>,
                <span class="hljs-string">'  FragTexCoord0 = TexCoord0;'</span>,
                <span class="hljs-string">'  FragTexCoord1 = TexCoord1;'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> kernelglsl = [];
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nbSamples; i++ ) {
                kernelglsl.push( <span class="hljs-string">'kernel['</span> + i + <span class="hljs-string">'] = vec4('</span> + kernel[ i * <span class="hljs-number">3</span> ] + <span class="hljs-string">','</span> + kernel[ i * <span class="hljs-number">3</span> + <span class="hljs-number">1</span> ] + <span class="hljs-string">', '</span> + kernel[ i * <span class="hljs-number">3</span> + <span class="hljs-number">2</span> ] + <span class="hljs-string">', '</span> + kernel[ i * <span class="hljs-number">3</span> + <span class="hljs-number">3</span> ] + <span class="hljs-string">');'</span> );
            }
            kernelglsl = kernelglsl.join( <span class="hljs-string">'\n'</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>var ssaoRadiusMin = this._sceneRadius <em> 0.002;
var ssaoRadiusMax = this._sceneRadius </em> 0.05;
var ssaoRadiusStep = ( ssaoRadiusMax - ssaoRadiusMin ) / 200.0;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> fragmentshader = [
                <span class="hljs-string">''</span>,
                Composer.Filter.defaultFragmentShaderHeader,
                <span class="hljs-string">'varying vec3 FragTexCoord1;'</span>,
                <span class="hljs-string">'uniform sampler2D Texture1;'</span>,
                <span class="hljs-string">'uniform sampler2D Texture2;'</span>,
                <span class="hljs-string">'uniform mat4 projection;'</span>,
                <span class="hljs-string">'uniform vec2 noiseSampling;'</span>,
                <span class="hljs-string">'uniform float Power;'</span>, <span class="hljs-comment">//'+ '{ 'min': 0.1, 'max': 16.0, 'step': 0.1, 'value': 1.0 }',</span>
                <span class="hljs-string">'uniform float Radius;'</span>, <span class="hljs-comment">//'+ '{ 'min': ' + ssaoRadiusMin +', 'max': ' + ssaoRadiusMax + ', 'step': '+ ssaoRadiusStep + ', 'value': 0.01 }',</span>
                <span class="hljs-string">'uniform float AngleLimit;'</span>,
                <span class="hljs-string">'#define NB_SAMPLES '</span> + <span class="hljs-keyword">this</span>._nbSamples,
                <span class="hljs-string">'float depth;'</span>,
                <span class="hljs-string">'float znear, zfar, zrange;'</span>,
                <span class="hljs-string">'vec3 normal;'</span>,
                <span class="hljs-string">'vec3 position;'</span>,
                <span class="hljs-string">'vec4 kernel['</span> + nbSamples + <span class="hljs-string">'];'</span>,

                Composer.Filter.shaderUtils,

                <span class="hljs-string">'mat3 computeBasis()'</span>,
                <span class="hljs-string">'{'</span>,
                <span class="hljs-string">'  vec2 uvrand = FragTexCoord0*noiseSampling;'</span>,
                <span class="hljs-string">'  //uvrand = rand(gl_FragCoord.xy);'</span>,
                <span class="hljs-string">'  vec3 rvec = texture2D(Texture2, uvrand*2.0).xyz*2.0-vec3(1.0);'</span>,
                <span class="hljs-string">'  //vec3 rvec = normalize(vec3(uvrand,0.0));'</span>,
                <span class="hljs-string">'  vec3 tangent = normalize(rvec - normal * dot(rvec, normal));'</span>,
                <span class="hljs-string">'  vec3 bitangent = cross(normal, tangent);'</span>,
                <span class="hljs-string">'  mat3 tbn = mat3(tangent, bitangent, normal);'</span>,
                <span class="hljs-string">'  return tbn;'</span>,
                <span class="hljs-string">'}'</span>,

                <span class="hljs-string">'float getDepthValue(vec4 v) {'</span>,
                <span class="hljs-string">'  float depth = unpack4x8ToFloat(v);'</span>,
                <span class="hljs-string">'  depth = depth*zrange+znear;'</span>,
                <span class="hljs-string">'  //depth = depth*zrange;'</span>,
                <span class="hljs-string">'  return -depth;'</span>,
                <span class="hljs-string">'}'</span>,

                <span class="hljs-string">'void main (void)'</span>,
                <span class="hljs-string">'{'</span>,
                kernelglsl,
                <span class="hljs-string">'  vec4 p = texture2D(Texture0, FragTexCoord0);'</span>,
                <span class="hljs-string">'  if (dot(p,p) &lt; 0.001) { '</span>,
                <span class="hljs-string">'     gl_FragColor = vec4(1.0,1.0,1.0,0.0);'</span>,
                <span class="hljs-string">'     return;'</span>,
                <span class="hljs-string">'  }'</span>,
                <span class="hljs-string">'  znear = projection[3][2] / (projection[2][2]-1.0);'</span>,
                <span class="hljs-string">'  zfar = projection[3][2] / (projection[2][2]+1.0);'</span>,
                <span class="hljs-string">'  zrange = zfar-znear;'</span>,
                <span class="hljs-string">'  depth = getDepthValue(texture2D(Texture1, FragTexCoord0));'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>B = (A - znear)/(zfar-znear);’,
B = A/(zfar-znear) - znear/(zfar-znear);’,
B+ znear/(zfar-znear) = A/(zfar-znear) ;’,
(zfar-znear)<em>(B+ znear/(zfar-znear)) = A ;’,
(zfar-znear)</em>B+ znear = A ;’,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-string">'  if ( -depth &lt; znear) {'</span>,
                <span class="hljs-string">'     gl_FragColor = vec4(1.0,1.0,1.0,0.0);'</span>,
                <span class="hljs-string">'     return;'</span>,
                <span class="hljs-string">'  }'</span>,

                <span class="hljs-string">'  normal = decodeNormal(unpack4x8To2Float(p));'</span>,

                <span class="hljs-string">'  position = -FragTexCoord1*depth;'</span>,
                <span class="hljs-string">'  position.z = -position.z;'</span>,

                <span class="hljs-string">''</span>,
                <span class="hljs-string">' mat3 tbn = computeBasis();'</span>,
                <span class="hljs-string">' float occlusion = 0.0;'</span>,
                <span class="hljs-string">' for (int i = 0; i &lt; NB_SAMPLES; i++) {'</span>,
                <span class="hljs-string">'    vec3 vecKernel = vec3(kernel[i]);'</span>,
                <span class="hljs-string">'    vecKernel[2] = max(AngleLimit,vecKernel[2]);'</span>,
                <span class="hljs-string">'    vec3 sample = tbn * vec3(vecKernel);'</span>,
                <span class="hljs-string">'    vec3 dir = sample;'</span>,
                <span class="hljs-string">'    float w = dot(dir, normal);'</span>,
                <span class="hljs-string">'    float dist = 1.0-kernel[i].w;'</span>,
                <span class="hljs-string">'    w *= dist*dist*Power;'</span>,
                <span class="hljs-string">'    sample = dir * float(Radius) + position.xyz;'</span>,

                <span class="hljs-string">'    vec4 offset = projection * vec4(sample,1.0);'</span>,
                <span class="hljs-string">'    offset.xy /= offset.w;'</span>,
                <span class="hljs-string">'    offset.xy = offset.xy * 0.5 + 0.5;'</span>,

                <span class="hljs-string">'    float sample_depth = getDepthValue(texture2D(Texture1, offset.xy));'</span>,
                <span class="hljs-string">'    float range_check = abs(sample.z - sample_depth) &lt; float(Radius) ? 1.0 : 0.0;'</span>,
                <span class="hljs-string">'    occlusion += (sample_depth &gt; sample.z ? 1.0 : 0.0) * range_check*w;'</span>,

                <span class="hljs-string">' }'</span>,
                <span class="hljs-string">' occlusion = 1.0 - (occlusion / float(NB_SAMPLES));'</span>,
                <span class="hljs-string">' gl_FragColor = vec4(vec3(occlusion),1.0);'</span>,
                <span class="hljs-string">'}'</span>,
                <span class="hljs-string">''</span>
            ].join( <span class="hljs-string">'\n'</span> );

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'VERTEX_SHADER'</span>, vertexshader ),
                <span class="hljs-keyword">new</span> Shader( <span class="hljs-string">'FRAGMENT_SHADER'</span>, fragmentshader ) );

            stateSet.setAttributeAndModes( program );
            <span class="hljs-keyword">this</span>._dirty = <span class="hljs-literal">false</span>;
        }
    } );

    <span class="hljs-keyword">return</span> Composer;
} );</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
